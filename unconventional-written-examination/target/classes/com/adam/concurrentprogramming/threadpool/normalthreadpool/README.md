# 手搓线程池要点

## 核心组件

### 1. 线程分类
- **核心线程（CoreThread）**：常驻线程，永不退出，使用 `take()` 阻塞等待
- **支持线程（SupportThread）**：临时线程，超时退出，使用 `poll(timeout)` 带超时获取

### 2. 任务提交流程
```
提交任务 → 核心线程未满？ → 创建核心线程
         ↓ 是
         核心线程已满 → 队列未满？ → 放入队列
                     ↓ 是
                     队列已满 → 总线程数未满？ → 创建支持线程
                               ↓ 是
                               执行拒绝策略
```

## 关键注意点

### 线程安全
- **线程列表管理**：`coreThreadList` 和 `supportThreadList` 需要线程安全
  - 建议使用 `CopyOnWriteArrayList` 或 `Collections.synchronizedList()`
  - 或使用 `ReentrantLock` 保护关键区域

### 任务执行
- **直接调用 `run()`**：在工作线程中直接执行，不是 `start()`
- **异常处理**：任务异常不应影响工作线程，需要 try-catch 包裹

### 资源管理
- **支持线程清理**：线程退出后应从列表中移除，避免内存泄漏
- **优雅关闭**：需要提供 `shutdown()` 方法，中断所有线程并等待完成

### 拒绝策略
- **默认策略**：直接丢弃（当前实现）
- **其他策略**：抛异常、调用者执行、丢弃最老任务等

### 常见问题
1. **竞态条件**：多线程同时检查 `size()` 和创建线程，需要同步
2. **任务丢失**：新创建线程时，当前任务可能未正确处理
3. **线程泄漏**：支持线程退出后未从列表移除

## 改进方向

1. 使用 `AtomicInteger` 统计线程数，避免竞态
2. 实现完整的拒绝策略接口
3. 添加 `shutdown()` 和 `shutdownNow()` 方法
4. 支持线程池状态管理（RUNNING、SHUTDOWN、STOP等）
5. 添加监控指标：活跃线程数、队列大小、完成任务数等

